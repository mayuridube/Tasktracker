
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Chat</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        #chat { height: 300px; overflow-y: scroll; border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; }
        #users { float: right; width: 150px; height: 300px; overflow-y: scroll; border: 1px solid #ccc; padding: 10px; }
        .message { margin-bottom: 5px; }
        .system { color: #888; }
        form { display: flex; }
        input[type="text"] { flex: 1; padding: 5px; }
        button { padding: 5px 10px; background: #007bff; color: white; border: none; }
    </style>
</head>
<body>
    <h1>WebSocket Chat</h1>
    
    <div id="users">
        <h3>Online Users</h3>
        <ul id="usersList"></ul>
    </div>
    
    <div id="chat"></div>
    
    <form id="messageForm">
        <input type="text" id="messageInput" placeholder="Type a message..." autocomplete="off">
        <button type="submit">Send</button>
    </form>
    
    <p>
        <input type="text" id="nameInput" placeholder="Your name">
        <button id="setNameButton">Set Name</button>
    </p>
    
    <script>
        const chat = document.getElementById('chat');
        const usersList = document.getElementById('usersList');
        const messageForm = document.getElementById('messageForm');
        const messageInput = document.getElementById('messageInput');
        const nameInput = document.getElementById('nameInput');
        const setNameButton = document.getElementById('setNameButton');
        
        let socket;
        
        // Connect to WebSocket server
        function connectWebSocket() {
            // Use the correct WebSocket URL (ws:// or wss:// protocol)
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = protocol + '//' + window.location.host + '/ws';
            
            console.log('Connecting to WebSocket at:', wsUrl);
            socket = new WebSocket(wsUrl);
            
            // Connection opened
            socket.addEventListener('open', (event) => {
                console.log('WebSocket connection established');
                addSystemMessage('Connected to server');
            });
            
            // Listen for messages
            socket.addEventListener('message', (event) => {
                console.log('Message from server:', event.data);
                const message = JSON.parse(event.data);
                
                switch (message.type) {
                    case 'welcome':
                        addSystemMessage(message.message);
                        break;
                        
                    case 'chat':
                        addChatMessage(message.senderName, message.text);
                        break;
                        
                    case 'systemMessage':
                        addSystemMessage(message.message);
                        break;
                        
                    case 'clientList':
                        updateUsersList(message.clients);
                        break;
                }
            });
            
            // Connection closed
            socket.addEventListener('close', (event) => {
                console.log('WebSocket connection closed');
                addSystemMessage('Disconnected from server. Trying to reconnect...');
                
                // Try to reconnect after 3 seconds
                setTimeout(connectWebSocket, 3000);
            });
            
            // Connection error
            socket.addEventListener('error', (event) => {
                console.error('WebSocket error:', event);
                addSystemMessage('Error connecting to server');
            });
        }
        
        // Add a chat message
        function addChatMessage(sender, text) {
            const messageElement = document.createElement('div');
            messageElement.className = 'message';
            messageElement.textContent = sender + ': ' + text;
            chat.appendChild(messageElement);
            chat.scrollTop = chat.scrollHeight;
        }
        
        // Add a system message
        function addSystemMessage(text) {
            const messageElement = document.createElement('div');
            messageElement.className = 'message system';
            messageElement.textContent = 'ðŸ”” ' + text;
            chat.appendChild(messageElement);
            chat.scrollTop = chat.scrollHeight;
        }
        
        // Update the users list
        function updateUsersList(clients) {
            usersList.innerHTML = '';
            
            clients.forEach(client => {
                const li = document.createElement('li');
                li.textContent = client.name;
                usersList.appendChild(li);
            });
        }
        
        // Send a chat message
        function sendChatMessage(text) {
            if (!socket || socket.readyState !== WebSocket.OPEN || !text.trim()) {
                return;
            }
            
            const message = {
                type: 'chat',
                text: text.trim()
            };
            
            socket.send(JSON.stringify(message));
            messageInput.value = '';
        }
        
        // Set the user's name
        function setUserName(name) {
            if (!socket || socket.readyState !== WebSocket.OPEN || !name.trim()) {
                return;
            }
            
            const message = {
                type: 'setName',
                name: name.trim()
            };
            
            socket.send(JSON.stringify(message));
            addSystemMessage('You changed your name to ' + name.trim());
        }
        
        // Event listeners
        messageForm.addEventListener('submit', (e) => {
            e.preventDefault();
            sendChatMessage(messageInput.value);
        });
        
        setNameButton.addEventListener('click', () => {
            setUserName(nameInput.value);
        });
        
        // Initialize WebSocket connection
        connectWebSocket();
    </script>
</body>
</html>
